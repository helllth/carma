name: Deployment

run-name: >
  ${{ github.event.head_commit.message || 'Triggered Deployment' }}
  ${{ github.event.inputs['project-name'] || github.event.client_payload['project-name'] }} --
  ${{ github.event.inputs.target || github.event.client_payload.target || github.ref_name }}-deployment

on:
  workflow_dispatch:
    inputs:
      project-name:
        description: "Please enter a project name"
        required: true
      version-manipulator:
        description: "Release type (one of): patch, minor, major, prepatch, preminor, premajor, prerelease (Will change the version number of the project.)"
        required: false
      target:
        type: choice
        description: "Where should I deploy?"
        options:
          - live
          - dev
      create-docker-image:
        type: boolean
        description: Create a Docker image? ðŸ³
        required: false

  push:
    branches:
      - dev

  repository_dispatch:
    types: [trigger-workflow]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Set environment variables
        run: |
          echo "PROJECT_NAME=${{ github.event.inputs['project-name'] || github.event.client_payload['project-name'] || 'Unknown Project' }}" >> $GITHUB_ENV
          echo "TARGET=${{ github.event.inputs.target || github.event.client_payload.target || github.ref_name }}" >> $GITHUB_ENV
          echo "VERSION_MANIPULATOR=${{ github.event.inputs['version-manipulator'] || github.event.client_payload['version-manipulator'] || 'not provided' }}" >> $GITHUB_ENV

          if [ "${{ github.event.inputs['create-docker-image'] }}" != "" ]; then
            echo "CREATE_DOCKER_IMAGE=${{ github.event.inputs['create-docker-image'] }}" >> $GITHUB_ENV
          elif [ "${{ github.event.client_payload['create-docker-image'] }}" != "" ]; then
            echo "CREATE_DOCKER_IMAGE=${{ github.event.client_payload['create-docker-image'] }}" >> $GITHUB_ENV
          else
            echo "CREATE_DOCKER_IMAGE=false" >> $GITHUB_ENV
          fi

      - name: Echo deployment details
        run: |
          echo "Project Name: $PROJECT_NAME"
          echo "Target: $TARGET"
          echo "Version Manipulator: $VERSION_MANIPULATOR"
          echo "Create Docker Image: $CREATE_DOCKER_IMAGE"
        shell: bash
